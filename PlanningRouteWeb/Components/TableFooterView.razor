
@{
    var grpData = LoadFooter();
}
<tr>
    <td rowspan="2" colspan="4" class="sticky-col first-col" style=""></td>
    <td class="text-end fw-bold sticky-col six-col" style="font-size: 12px;">
        @(beforeSale == 0 ? beforeSale : beforeSale.ToString("0,0", CultureInfo.InvariantCulture))
    </td>
    <td class="text-end fw-bold sticky-col sevent-col" style="font-size: 12px;">
        @(beforeMTD == 0 ? beforeMTD : beforeMTD.ToString("0,0", CultureInfo.InvariantCulture))
    </td>
    <td class="text-end fw-bold sticky-col eight-col" style="font-size: 12px;">
        @(currentMTD == 0 ? currentMTD : currentMTD.ToString("0,0", CultureInfo.InvariantCulture))
    </td>
    @if (!HideMaster)
    {
        <td class="text-center fw-bold sticky-col nine-col" style="font-size: 12px;">@Data.Count(c => c.MONDAY == true)</td>
        <td class="text-center fw-bold sticky-col ten-col" style="font-size: 12px;">@Data.Count(c => c.TUESDAY == true)</td>
        <td class="text-center fw-bold sticky-col eleven-col" style="font-size: 12px;">@Data.Count(c => c.WEDNESDAY == true)</td>
        <td class="text-center fw-bold sticky-col twelve-col" style="font-size: 12px;">@Data.Count(c => c.THURSDAY == true)</td>
        <td class="text-center fw-bold sticky-col thirteen-col" style="font-size: 12px;">@Data.Count(c => c.FRIDAY == true)</td>
        <td class="text-center fw-bold sticky-col fourteen-col" style="font-size: 12px;">@Data.Count(c => c.SATURDAY == true)</td>
        <td class="text-center fw-bold sticky-col fifteen-col" style="font-size: 12px;">@Data.Count(c => c.SUNDAY == true)</td>
        <td class="sticky-col sixteen-col" colspan="3" rowspan="2"></td>
    }
    
   @*  <td rowspan="2" class="text-end fw-bold" style="font-size: 12px;">
        @Data.Sum(x => x.SALE_LAST_WEEK).ToString("0,0", CultureInfo.InvariantCulture)
    </td> *@
    <td rowspan="2" class="text-end fw-bold" style="font-size: 12px;">
        @DropMonth.Sum(x =>x)
    </td>
    @foreach (var (obj, index) in grpData.WithIndex())
    {
        var error = obj.COUNT_STATUS_MANUAL == obj.MAX_DROP ? "success" : obj.COUNT_STATUS_MANUAL > obj.MAX_DROP ? "over" : "error";
        <td class=@($"text-center fw-bold {error}") >
            <RadzenText  class="mb-0" Style="font-size: 12px; cursor : pointer;">
                <div class="fw-bold">
                    @obj.COUNT_STATUS_MANUAL
                </div>
            </RadzenText>
           
        </td>
      @*   <td rowspan="@(StateContainer.DateCurrent.ToContainsDate(obj.FieldDate) ? 1 : 2)" class="text-end fw-bold" style="font-size: 12px;">
            @obj.SUM_SALETOTAL
        </td> *@
        <td rowspan="1" class="text-end" style=" cursor : pointer;">
            <RadzenText MouseEnter="@(args => ShowTooltip(args , "ยอดขาย") )" class="mb-0" Style="font-size: 12px;">
                <div class="fw-bold">
                    @if(obj.SUM_SALETOTAL == 0)
                    {
                        @obj.SUM_SALETOTAL
                    }
                    else
                    {
                        @obj.SUM_SALETOTAL.ToString("0,0", CultureInfo.InvariantCulture)
                    }
                </div>
            </RadzenText>
        </td>
        <td rowspan="2" style="font-size: 12px;"></td>
        if ((index + 1) % 7 == 0)
        {
            var SaleWeek = CalSumSaleWeek(grpData, index);
            var diff = CalSumSaleWeekDiff(grpData, index);

            <td rowspan="2" class="text-end fw-bold" style="font-size: 12px;">
                @if (SaleWeek == 0)
                {
                    @SaleWeek
                }else
                {
                    @SaleWeek.ToString("0,0", CultureInfo.InvariantCulture)
                }
            </td>
            <td rowspan="2" class="text-end fw-bold" style="font-size: 12px;">
                @if (diff == 0)
                {
                    @diff
                }
                else
                {
                    @diff.ToString("0,0", CultureInfo.InvariantCulture)
                }
            </td>
        }
    }
</tr>
<tr>
    <td class="sticky-col six-col"></td>
    @{
        var before = beforeMTD -beforeSale;
        var style1 = before > 1 ? "sum-current-mtd" : "sum-error-mtd";
        var style2 = (currentMTD - beforeMTD) > 1 ? "sum-current-mtd" : "sum-error-mtd";
    }
    <td class=@($"text-end fw-bold {style1} sticky-col sevent-col") style="font-size: 12px;">
        @if (before == 0)
        {
            @before
        }
        else
        {
            @(before.ToString("0,0", CultureInfo.InvariantCulture))
        }
    </td>
    <td class=@($"text-end fw-bold {style2} sticky-col eight-col") style="font-size: 12px;">
        @((currentMTD - beforeMTD) == 0 ? (currentMTD - beforeMTD) : (currentMTD - beforeMTD).ToString("0,0", CultureInfo.InvariantCulture))
    </td>
    @if (!HideMaster)
    {
        <td class="text-center fw-bold sticky-col nine-col" style="font-size: 12px;">@(Target - Data.Count(c => c.MONDAY == true))</td>
        <td class="text-center fw-bold sticky-col ten-col" style="font-size: 12px;">@(Target - Data.Count(c => c.TUESDAY == true))</td>
        <td class="text-center fw-bold sticky-col eleven-col" style="font-size: 12px;">@(Target - Data.Count(c => c.WEDNESDAY == true))</td>
        <td class="text-center fw-bold sticky-col twelve-col" style="font-size: 12px;">@(Target - Data.Count(c => c.THURSDAY == true))</td>
        <td class="text-center fw-bold sticky-col thirteen-col" style="font-size: 12px;">@(Target - Data.Count(c => c.FRIDAY == true))</td>
        <td class="text-center fw-bold sticky-col fourteen-col" style="font-size: 12px;">@(Target - Data.Count(c => c.SATURDAY == true))</td>
        <td class="text-center fw-bold sticky-col fifteen-col" style="font-size: 12px;">@(Target - Data.Count(c => c.SUNDAY == true))</td>
    }

    @foreach (var (obj, index) in grpData.WithIndex())
    {
        var error = obj.COUNT_STATUS_MANUAL == obj.MAX_DROP ? "success" : obj.COUNT_STATUS_MANUAL > obj.MAX_DROP ? "over" :  "error";

        <td class=@($"text-center fw-bold {error}")>
            <RadzenText class="mb-0" Style="font-size: 12px; cursor : pointer;">
                <div class="fw-bold">@obj.MAX_DROP</div>
            </RadzenText>
        </td>
      @*   if (StateContainer.DateCurrent.ToContainsDate(obj.FieldDate))
        {
            <td class="text-end fw-bold" style="font-size: 12px;">
                @obj.SUM_SALETOTAL_TOTAL
            </td>
        } *@
        <td class="text-end" style="cursor : pointer;">
            <RadzenText MouseEnter="@(args => ShowTooltip(args , "ยอดขายประมาณการณ์") )" class="mb-0" Style="font-size: 12px; ">
                <div class="fw-bold">
                    @if(obj.SUM_SALETOTAL_TOTAL == 0)
                    {
                        @obj.SUM_SALETOTAL_TOTAL
                    }
                    else
                    {
                        @obj.SUM_SALETOTAL_TOTAL.ToString("0,0", CultureInfo.InvariantCulture)
                    }
                </div>
            </RadzenText>
        </td>
    }
</tr>

@inject StateContainer StateContainer
@inject TooltipService TooltipService
@code {
    [Parameter]
    public IDictionary<string, ColumnProperty> Columns { get; set; } = new Dictionary<string, ColumnProperty>();
    [Parameter]
    public List<PlanningMasterData2> Data { get; set; } = new();
    [Parameter]
    public List<int> DropMonth { get; set; } = new();
    [Parameter]
    public int Target { get; set; }
    [Parameter]
    public bool HideMaster { get; set; }

    public int beforeSale;
    public int beforeMTD;
    public int currentMTD;

    private void ShowTooltip(ElementReference elementReference, string text, TooltipOptions? options = null) => TooltipService.Open(elementReference, $"{text}", new TooltipOptions { Style = "font-size: 16px", Position = TooltipPosition.Top });

    protected override void OnInitialized()
    {
        beforeSale = Data.Sum(x => !string.IsNullOrWhiteSpace(x.BEFORE_SALE) ? int.Parse(x.BEFORE_SALE) : 0);
        beforeMTD = Data.Sum(x => !string.IsNullOrWhiteSpace(x.BEFORE_MTD) ? int.Parse(x.BEFORE_MTD) : 0);
        currentMTD = Data.Sum(x => !string.IsNullOrWhiteSpace(x.CURRENT_MTD) ? int.Parse(x.CURRENT_MTD) : 0);
    }


    private List<ColumnFooter> LoadFooter()
    {
        var planDetail = new List<PlanningDetail2>();
        var planDrop = new List<PlanningDetail2>();
        var planDrop2 = new List<PlanningDetail2>();
        foreach (var x in Data)
        {
            if(x.GroupData.Count() > 1)
            {
                foreach (var i in x.GroupData.Skip(0))
                {
                    foreach (var d in i.GETPLAN_DETAIL)
                    {
                        if (d.RANK != null)
                        {
                            planDrop.Add(d);
                        }
                        planDrop2.Add(d);
                    }
                }
            }
            else
            {
                planDrop.AddRange(x.GETPLAN_DETAIL);
                planDrop2.AddRange(x.GETPLAN_DETAIL);
            }

            planDetail.AddRange(x.GETPLAN_DETAIL);
        }

        return planDetail.GroupBy(a => a.CALENDAR_DATE, (key, grp) => new ColumnFooter
        {
            FieldDate = key,
            COUNT_STATUS_MANUAL = grp.FirstOrDefault()!.IsCurrent ? planDrop2.Where(x => x.CALENDAR_DATE == key && x.STATUS_MANUAL).Count() :  planDrop.Where(x => x.CALENDAR_DATE == key && x.DOC_TYPE == "1").Count(),
            // COUNT_STATUS_MANUAL2 = planDrop2.Where(x => x.CALENDAR_DATE == key && x.STATUS_MANUAL ).Count(),
            MAX_DROP = !string.IsNullOrWhiteSpace(grp.FirstOrDefault()!.MAX_DROP) ? int.Parse(grp.FirstOrDefault()!.MAX_DROP) : 0,
            IsCurrent = grp.FirstOrDefault()!.IsCurrent,
            SUM_SALETOTAL = StateContainer.DateCurrent.ToContainsDate(key) ?
            grp.Sum(x => x.STATUS_MANUAL && !string.IsNullOrWhiteSpace(x.DOC_TYPE) || x.IsCurrent ? x.SALETOTAL : 0):
            grp.Sum(x => !string.IsNullOrWhiteSpace(x.DOC_TYPE) ? x.SALETOTAL : 0),
            SUM_SALETOTAL_TOTAL = grp.Where(x => x.STATUS_MANUAL).Sum(x => string.IsNullOrWhiteSpace(x.DOC_TYPE) ? x.SALETOTAL : x.AMOUNT),
        })
        .ToList();
    }

    private double CalSumSaleWeek(List<ColumnFooter> row ,int index)
    {
        var task = 7;
        var skip = index - task;
        var sum = row.Skip(skip).Take(task).Sum(s => s.SUM_SALETOTAL);
        return sum;
    }

    private double CalSumSaleWeekDiff(List<ColumnFooter> row, int index)
    {
        var task = 7;
        var skip = index - task;
        var last = Data.Sum(x => x.SALE_LAST_WEEK_END);

        double sum = 0;
        if (index == task)
        {
            var totalWeek = row.Skip(skip).Take(task).Sum(s => s.SUM_SALETOTAL);
            sum = last - totalWeek;
            return sum;
        }
        else
        {
            var totalWeek = row.Skip(skip).Take(task).Sum(s => s.SUM_SALETOTAL);
            var lastWeek = row.Skip(skip - task).Take(task).Sum(s => s.SUM_SALETOTAL);
            sum = lastWeek - totalWeek;
            return sum;
        }
    }
}
